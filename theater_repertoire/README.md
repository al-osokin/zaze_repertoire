# Система управления афишей театра

Веб-приложение помогает театру «Зазеркалье» собирать ежемесячную афишу: парсер загружает расписание с сайта, сопоставляет спектакли с базой и генерирует wiki-разметку для публикации. При необходимости афишу можно собрать вручную из табличного черновика.

## Основные возможности

- Парсинг расписания с сайта театра и сохранение событий в таблицу `events_raw`.
- Автоматическое сопоставление спектаклей по полному названию (`site_title`) с нормализацией написаний («ё» → «е» и т.п.).
- Интерфейс «Парсинг афиши»: загрузка выбранного месяца, просмотр всех найденных событий, корректировка сопоставлений и мгновенное получение wiki/TSV текста с кнопками копирования.
- Интерфейс «Создать вручную»: преобразование табличного черновика в wiki-разметку без участия парсера.
- Управление спектаклями: хранятся основные данные, ссылки на wiki-страницы, отметки «абонемент», шаблоны страниц и точные названия с сайта.
- Административный вход по логину/паролю (учётные записи находятся в таблице `users`).

## Актуальный сценарий работы

1. Зайти на страницу «Парсинг афиши» (`scraper.php`).
2. Выбрать месяц/год и выполнить загрузку расписания.
3. При необходимости вручную назначить спектакли в таблице событий.
4. Нажать «Сформировать афишу» и скопировать wiki-разметку или исходный TSV-текст.
5. При необходимости расчистить базу и повторить шаги (старые события перезаписываются).

Для разовых правок/добавок можно перейти на страницу «Создать вручную» (`manual.php`) и вставить табличный черновик вида `дата\tвремя\tназвание\tкод`.

## База данных

- `plays` — хранит спектакли. Важные поля: `short_name` (служебное сокращение), `site_title` (точное название с сайта), `full_name` (вики-разметка), `wiki_link`, `hall`, `is_subscription` и др.
- `events_raw` — распарсенные события с привязкой к спектаклю и реквизитами билета.
- `repertoire_history` — сохранённые версии афиши (используется только для просмотра ранее созданных черновиков).
- `play_templates` — шаблоны страниц «В ролях».
- `users` — учётные записи администраторов.

Экспорт рабочей базы находится в `avo_zaze_new.sql`, структура — в `schema.sql`.

## Установка и запуск

1. Подготовить базу MySQL/MariaDB и импортировать `schema.sql` или актуальный дамп (`avo_zaze_new.sql`).
2. Скопировать `config.php.orig` в `config.php` и указать параметры подключения, затем убедиться, что расширения `pdo_mysql`, `curl`, `dom` включены.
3. Разместить файлы приложения на PHP-сервере (рекомендуется PHP 8.1+).
4. Открыть `login.php`, авторизоваться и перейти на главную страницу (`index.php`).

## Разработка

- Основные PHP файлы находятся в корне каталога `theater_repertoire/`.
- Для генерации афиши из распарсенных данных используется класс `WikiGenerator` (`wiki_generator.php`).
- Статичные стили — в `css/main.css`; подключение Tailwind из CDN при необходимости уже присутствует в шаблонах страниц.
- Перед внесением изменений в схему базы обновляйте `schema.sql` и рабочий дамп.

## Контрольные точки

- `scraper.php` показывает результат генерации прямо на странице (без сохранения в историю) и позволяет копировать оба вывода.
- `admin.php` отображает список спектаклей по названию на сайте и даёт доступ к редактированию и шаблонам.
- `manual.php` сохраняет возможность ручного создания афиши в старом формате.

## Что дальше

- Автоматическое сохранение последней сгенерированной афиши в `repertoire_history` по команде.
- Подготовка шаблонов «В ролях» к автоматическому созданию страниц.
- Интеграция с VK API для публикации афиши из приложения.
