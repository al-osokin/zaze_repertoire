# План реализации интеграции с VK API

### Этап 1: Подготовка и настройка

1.  **Создание приложения VK:**
    *   Необходимо будет создать Standalone-приложение в [панели разработчика VK](https://vk.com/apps?act=manage). Это даст нам `client_id` (ID приложения), необходимый для получения токена.

2.  **Получение `access_token`:**
    *   Рабочий токен берём из исторического Standalone‑приложения театра (classic OAuth `https://oauth.vk.com`). Только такие токены дают право `pages`, поэтому автоматизация построена вокруг старого приложения.
    *   VK ID (через `id.vk.ru`, PKCE) оставлен вынужденным запасным вариантом: он выдаёт лишь `vkid.personal_info` и не подходит для `pages.*`, но поддерживается в коде для совместимости.

3.  **Конфигурация в проекте:**
    *   Создать новый конфигурационный файл (например, `vk_config.php`) или добавить в существующий (`config.php`) константы для хранения `access_token`, `group_id` и `user_id` (ID пользователя, от имени которого будут публиковаться страницы). Важно добавить этот файл в `.gitignore`, чтобы не коммитить секретные данные.

### Этап 2: Создание модуля для работы с VK API

1.  **Проектирование класса `VKApiClient`:**
    *   Создать файл `theater_repertoire/app/ApiClient/VKApiClient.php`.
    *   Этот класс будет инкапсулировать всю логику взаимодействия с VK API.
    *   Он будет содержать приватные поля для токена и ID группы.
    *   Основной метод будет `executeRequest($method, $params)`, который формирует и отправляет `curl` запрос к `https://api.vk.com/method/`, добавляя в него `access_token` и версию API (`v=5.131`).

2.  **Реализация методов API:**
    *   В классе `VKApiClient` реализовать публичные методы (готово):
        *   `getPagesList()`: Вызывает `pages.getTitles` для получения списка существующих страниц.
        *   `getPage($page_id)`: Вызывает `pages.get` для получения контента конкретной страницы.
        *   `savePage($title, $text, $page_id = null)`: Вызывает `pages.save` и корректно обрабатывает числовой `page_id` в ответе.

### Этап 3: Интеграция с существующим кодом

1.  **Доработка интерфейса:**
    *   Кнопка «Опубликовать в VK» уже добавлена в `schedule.php` и `edit_cast.php`. Отдельный список страниц пока не реализован; просмотр доступных страниц выполняется через `vk_pages_test.php`.

2.  **Создание обработчика публикации:** (сделано)
    *   `publish_to_vk.php` принимает `performance_id`, сам подтягивает `vk_page_name`, генерирует карточку, публикует её и сохраняет текст; ошибки VK возвращаются в JSON, код 5 сбрасывает токен.

### Этап 4: Публикация месячной афиши и архива *(готово)*

1.  **Страница «Архив»**
    *   [x] Подтягивать актуальный текст страницы `[[Архив]]` через `pages.get` (`owner_id = -group_id`, `need_source = 1`).
    *   [x] Парсить блоки сезонов (`===N-й сезон YYYY-YYYY===`) и вставлять строку `* [[Месяц_Год|Месяц Год]]` в правильном порядке либо создавать новый блок для нового сезона.
    *   [x] Сохранять обновлённый текст обратно через `pages.save`.

2.  **Страницы спектаклей (плейсхолдеры)**
    *   [x] После парсинга месяца проходить по `events_raw` и для каждого `vk_page_name` создавать страницу плейcхолдера `==В ролях:== / ''СОСТАВ УТОЧНЯЕТСЯ'' / ссылка на билет`.
    *   [x] Перед созданием проверять существование страницы через `pages.get`. Сейчас VK возвращает `error_code = 15` и `error_msg = "Access denied: page not found"`, если страницы нет — использовать это как сигнал для создания.
    *   [x] Добавить задержку между запросами `pages.save` (около 0.5 секунды), чтобы не сталкиваться с антибот-защитой.

3.  **Публикация месячной таблицы**
    *   [x] Добавить на `scraper.php` кнопку «Опубликовать афишу в VK» (после генерации таблицы `WikiGenerator`).
    *   [x] При нажатии публиковать страницу месяца (`title = Месяц_Год`, `text = wikiOutput`), обновлять `[[Архив]]` и запускать создание плейсхолдеров.
    *   [x] После завершения выводить отчёт (ID страницы месяца, сколько плейсхолдеров создано/пропущено, ошибки).

### Этап 5: Тестирование и отладка

1.  **Модульное тестирование:**
    *   Написать простые тесты для `VKApiClient`, проверяющие корректность формирования запросов и обработки ответов от API (можно использовать моки или реальные, но безопасные запросы, например, `getTitles`).

2.  **Интеграционное тестирование:**
    *   Проверить весь процесс из интерфейса: генерация разметки -> нажатие кнопки "Опубликовать" -> проверка появления/обновления страницы в группе VK.
    *   Особое внимание уделить обработке ошибок: неверный токен, отсутствие прав, ошибки сети и т.д.
