# Актуальный контекст проекта "Администрирование Афиши Театра"

## Текущий фокус работы:
*   Интеграция с API ВКонтакте для публикации афиш и составов.
*   Отладка и реализация авторизации через OAuth 2.0, получение токена доступа.

## Последние изменения:
*   **Получен рабочий токен через старое Standalone‑приложение (classic OAuth).** Для публикации wiki‑страниц используется историческое приложение театра (App ID 3113337) и поток `oauth.vk.com` с правами `pages,offline`.
*   Страница `vk_settings.php` поддерживает оба сценария авторизации (classic/vkid), ведёт журнал ошибок и показывает активные права.
*   В `vk_oauth_callback.php` добавлены state+PKCE проверки, журналы и обработка обеих схем токенов.
*   Тестовая страница `vk_pages_test.php` успешно выводит список вики-страниц группы через `pages.getTitles`.
*   Добавлены кнопки «Опубликовать в VK» в `schedule.php`, `edit_cast.php` и новый сценарий публикации всей афиши на `scraper.php`.
*   `publish_to_vk.php` возвращает ошибки в JSON, сохраняет опубликованный текст и корректно обрабатывает числовой ответ `pages.save`.
*   В `VKApiClient` поддержаны числовые ответы, логирование сетевых ошибок, чтение страниц по названию/с исходником.
*   Добавлен CLI‑скрипт `scripts/backfill_vk_page_names.php` для разовой генерации `vk_page_name` у старых событий.
*   Реализован сервис `VkRepertoirePublisher`: публикация ежемесячной таблицы, автообновление страницы `[[Архив]]` и создание плейсхолдеров для карточек спектаклей (с защитой от дублей и задержкой между запросами).

## Следующие шаги:
1.  Проверить работоспособность `VKApiClient` с использованием полученного через OAuth токена.
2.  Реализовать и протестировать базовые операции со страницами: создание новой страницы и, если возможно, получение списка существующих страниц.
3.  Интегрировать эту логику с интерфейсом для публикации афиш.

## Активные решения и соображения:
*   Пользователь предпочитает, чтобы я изменял длинные тире на короткие непосредственно в шаблоне, а не модифицировал логику парсера, для обеспечения единообразия.
*   Проблема с уровнями заголовков в карточках спектаклей решена: заголовок "В ролях:" теперь генерируется как заголовок второго уровня (`==В ролях:==`), а остальные подзаголовки — третьего уровня (`===Пролог===`).

## Важные паттерны и предпочтения:
*   Не использовать команду `open http://...` для открытия браузера в WSL. Запускать PHP-сервер и предоставлять URL для ручной проверки.
*   Всегда использовать SQL-файлы для выполнения запросов `mariadb`, избегая прямой передачи запросов через командную строку `mariadb -e "..."`.

## Полученные знания и инсайты:
*   Важность единообразия в использовании символов (например, тире) в шаблонах для корректного парсинга.
*   Необходимость четкой структуры памяти проекта для эффективной работы после сброса контекста.
*   **Ключевые требования для авторизации VK ID (OAuth 2.0):**
    *   **PKCE обязателен:** Необходимо генерировать `code_verifier` (хранится в сессии) и `code_challenge` (отправляется в запросе на авторизацию). Метод шифрования - `S256`.
    *   **Актуальные эндпоинты:** Для авторизации используется `https://id.vk.ru/authorize`, а для обмена кода на токен — `https://id.vk.ru/oauth2/auth` (обязательно методом POST). Старый эндпоинт `oauth.vk.com` не поддерживает PKCE.
    *   **`device_id`:** Этот параметр возвращается VK в URL после редиректа и является обязательным при обмене кода на токен.
    *   **Настройки приложения VK:** Для локальной разработки (`localhost`) необходимо явно прописать `localhost` в поле "Базовый домен", а в "Доверенный redirect URI" указать полный путь, например, `http://localhost/vk_oauth_callback.php`.
    *   **Тип ключа:** Для серверной авторизации в параметре `client_secret` должен использоваться "Защищённый ключ" из настроек приложения.
