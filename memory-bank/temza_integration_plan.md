Нас по большей части интересует состав исполнителей (блок «Состав» во всплывающем окне системы «Темза»), дирижёр и концертмейстер (блок «Ответственные»), а также оперативные заметки («Задачи цехам», «Вызваны», текстовые инструкции над составом).

## Статус на 2025‑11‑24

### Скрапер `temza_scraper/`
- Отдельный Node‑workspace с Puppeteer+Cheerio. Настройки берутся из `temza_scraper/.env` (логин/пароль, `TEMZA_MONTH_URL_TEMPLATE` и т.д.).
- Команда запуска:  
  ```
  cd temza_scraper
  npm run dev -- --months=current,next
  ```  
  Параметры: `--month/-m` для одиночного месяца, `--months` для списка `YYYY-MM`, `--outDir` для нестандартного каталога сохранения.
- Скрапим все карточки месяца с префиксами `Сп.` и абонементами (`АБОНЕМЕНТ`, `АБОНЕМЕНТ (2)`...), игнорируем целевые мероприятия (`ЦЕЛЕВОЙ` и пр.). На каждую карточку открываем попап, снимаем `rawHtml`, парсим поля: дата/время/зал, тип (чип Temza), полный состав, ответственных, «Задачи цехам», «Вызваны», произвольные заметки.
- На сегодня выгружены месяцы Temза с октября 2025 назад до марта 2024 (августы пропущены — театр не работает). JSON лежат в `temza_scraper/output/temza-YYYY-MM.json`.
- В процессе разбора роли можно делить по запятым и помечать «ввод» (строки вида «Роль\nВвод …»). В HTML фиксируем вторые строки, чтобы отделять метки «Ввод», «Ввод стр. Росицкая» и т.п.

### Импорт и БД
- Таблицы: `temza_titles`, `temza_events`, `temza_cast`, `temza_cast_resolved`, `temza_role_rules`, служебные связи с `events_raw` и `plays`.
- CLI `php theater_repertoire/scripts/import_temza_json.php temza_scraper/output/temza-2025-11.json …` очищает соответствующие месяцы и загружает события. Названия очищаются от префиксов `Сп.`, `АБОНЕМЕНТ`, `АБОНЕМЕНТ (n)` и т.д. для нормализации.
- События Матчатся с афишей по `date + time + hall`. Если совпадения нет, событие помечается «Не сопоставлено» и может быть вручную связанo либо отмечено как «вне афиши».
- В `temza_cast_resolved` сохраняем каждые роль/артиста, исходный текст (`temza_role_source`), признак дебюта, флаги разбивки по запятым и игнорирования. Поле `temza_actor` расширено на длинные пары фамилий.
- Для спектаклей создана вспомогательная таблица сопоставлений Temza ↔ plays с гипотезой (`suggested_play_id`) и флажком подтверждения.

### Админка
- Страница **«Темза»**:  
  - Верхняя таблица — сопоставление названий. Видно оригинал Temza, нормализованное название, дата/время первого появления, подсказка и выпадающий список спектаклей. Есть быстрые кнопки «Принять гипотезу»/«Очистить». Строки отсортированы по дате+времени.  
  - Нижняя таблица — события месяца: дата, время, зал, статус соответствия афише. Можно связать с `events_raw` или отметить как «Игнорировать (вне афиши)». Для несопоставленных событий выводим чистое название Temza (без префиксов).
- Страница **«Темза роли»**:  
  - Слева список спектаклей с индикатором количества неподтверждённых ролей/групп (необработанные подсвечиваем).  
  - Справа — таблица ролей: Temza‑роль (при необходимости разделённая по запятым) + оригинальная строка серым, чекбоксы `split_comma` и `ignore_role` прямо под названием Temza.  
  - Центр строки — сопоставление: выпадающее поле роли карточки, отдельное поле «Группа» (для «Купцы», «Огурчики» и т.п.), кнопки «Сохранить», «Очистить».  
  - Справа колонка гипотез: мы строим предложения по совпадению названия роли (после чистки wiki‑разметки) и по артиста (если человек уже найден в карточке). Есть кнопка «Принять гипотезу».  
  - Подтверждённые строки отправляются вниз списка и подсвечиваются светло‑зелёным, чтобы сверху оставались нерешённые роли.  
  - Можно отмечать роли чекбоксом «Игнорировать» (например, вторая часть «Второй купец, юноша») и/или отключать деление по запятым для сложных спектаклей вроде «Детский альбом».

### Договорённости и особенности
- Автоматическое сопоставление событий делается только по дате+времени+зал (в репертуаре нет параллельных показов в одном слоте, так что совпадение почти гарантировано). Названия Temza могут отличаться, поэтому сравнение по имени вспомогательное.
- Целевые мероприятия («ЦЕЛЕВОЙ…») не участвуют в официальной афише, но мы их храним и явно помечаем в интерфейсе, чтобы можно было вручную подтвердить как игнорируемые.
- При обработке «Волшебной флейты» и других спектаклей важно, чтобы роли «1 Дама», «1 Мальчик» и т.п. попадали в группы, а не дублировались как индивидуальные роли. При ошибках можно стереть связку прямо в БД и заново применить групповое правило.
- В спектаклях вроде «Финист ясный сокол» и «Белый Клык» есть роли с несколькими персонажами через запятую. Первая часть обычно мапится на конкретную роль, остальные — либо в группу, либо игнорируются (есть чекбокс).  
- «Детский альбом» требует особого подхода: почти каждый артист исполняет несколько ролей, и списки могут меняться. Пока ручная настройка, в будущем может понадобиться сценарио без деления по запятой и без жёсткого списка карточки.
- Импорт объединяет слипшиеся фамилии из Temza; если встречаются склейки типа «Ярослава РаильтянинаЕвгений Кузнецов», нужно нормализовать по переходу строчная→прописная до записи в БД (TODO).
- Концертные программы (например, «Дирижёр — Дед Мороз», «Итальянский дворик») отображаются не как роли, а как списки исполнителей. В карточках для них используется заголовок «Участники концерта». Нужно добавить флажок `is_concert_program` в форме спектакля (рядом с «Это абонемент…») и особый формат вывода: общий список артистов через запятую, отдельные блоки вроде «Концерт ведут: …».
- На **temza.php** добавлены:  
  * Кнопка запуска скрапера (через `npm run dev`) прямо из админки + блок со сводкой и логами.  
  * Раздел «Предпросмотр карточек» — по выбранному месяцу собираются все будущие и неигнорируемые события, автоматически формируется вики-карточка (по шаблону спектакля и сопоставлениям ролей), показываются предупреждения по несопоставленным ролям и кнопки «Отправить в VK/Снять отметку». Статус хранится в `temza_events.published_at/published_by`. В этом же блоке отображаются зафиксированные изменения состава (см. ниже).
- Импортер `import_temza_json.php` перед очисткой месяца снимает «срез» `temza_events + temza_cast_resolved`, после загрузки нового JSON автоматически сравнивает старый и новый составы на уровне каждой роли/группы. Все обнаруженные изменения (замена спектакля, изменения в составе ролей/групп) сохраняются в новой таблице `temza_change_log` в виде JSON; эти записи отображаются в интерфейсе «Темза» рядом с карточками, чтобы можно было быстро увидеть, что поменялось, и подготовить уведомление.

## Предстоящие шаги
1. **UI запуска скрапера в админке** — кнопка «Собрать Temza» с очередью месяцев и задержками, чтобы не перегружать сервис.  
2. **Нормализация актёров** — делить слипшиеся фамилии/имена при импорте (regex `([а-яё])([А-ЯЁ])` → `$1, $2`), чтобы в `temза_cast_resolved` сразу хранились корректные списки.  
3. **Обработка концертов** — хранить `is_concert_program`, расширить генерацию карточек и роль‑маппинг (отдельные группы «Участники концерта», «Концерт ведут» и т.п.).  
4. **Уведомления о заменах** — (частично реализовано: diff по событиям фиксируется в `temza_change_log` и показывается в UI). Остаётся придумать, как превращать эти изменения в автоматические сообщения (VK/стена) и как хранить историю подтверждения/вывода уведомлений.  
5. **Контроль спектаклей** — проверять, что событие Temza совпадает с афишей; если спектакль заменён/отменён, подсвечивать и (в перспективе) готовить шаблон сообщения для соцсетей. Обработку отмен пока держим закомментированной до появления реального кейса.  
6. **Продолжение реверс‑скрапинга** — аккуратно (с задержками) дособрать прошлые месяцы Temза до марта 2024, пропуская августы.  
7. **Доработки интерфейса ролей** — предусмотреть галочку «гипотетическое сопоставление подтверждено» и возможность быстро отмечать спектакли, для которых всё обработано (в списке слева подсвечивать зелёным).
