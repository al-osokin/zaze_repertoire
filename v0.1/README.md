# Система управления репертуаром театра

Веб-приложение для создания репертуарных афиш театра с автоматическим преобразованием текста в вики-разметку.

## Возможности

- Преобразование черновика афиши в вики-разметку
- Управление базой спектаклей с сокращениями и полными названиями
- Шаблоны страниц для спектаклей с ролями
- История созданных афиш
- Защищённый доступ по логину/паролю
- Копирование результатов в буфер обмена
- Гибкое форматирование времени (HH и HHMM форматы)
- Автоматическая обработка продолжения дат (строки с табуляцией)
- Умная генерация ссылок для повторяющихся спектаклей
- Поддержка точного времени (15:30, 19:45 и т.д.)
- Специальная обработка абонементов с внешними ссылками на билеты
- Специальные отметки для премьер и других обозначений ("ПРЕМЬЕРА!", "БЕНЕФИС" и т.д.)

## Установка

### 1. Настройка базы данных

1. Создайте базу данных MariaDB/MySQL
2. Выполните SQL-скрипт из файла `schema.sql`
3. Обновите настройки подключения в файле `config.php`

### 2. Настройка сервера

1. Скопируйте файлы на веб-сервер с поддержкой PHP
2. Убедитесь, что PHP имеет расширение PDO для MySQL
3. Настройте права доступа к файлам (рекомендуется 755 для директорий, 644 для файлов)
4. **Если на сервере установлен WordPress**: Замените содержимое корневого `.htaccess` на содержимое файла `.htaccess-base`

### 3. Изменение логина и пароля (опционально)

Если вы хотите изменить стандартные учетные данные:

1. Откройте файл `test/generate_password.php`
2. Измените переменную `$password` на желаемый пароль
3. Запустите скрипт в браузере или через PHP CLI
4. Скопируйте сгенерированный хэш
5. Обновите строку в `schema.sql`:
   ```sql
   INSERT INTO users (username, password_hash) VALUES
   ('ваш_логин', 'скопированный_хэш');
   ```

### 4. Диагностика (при проблемах)

Если возникают ошибки 500, сначала проверьте:
1. Откройте `https://new.a-v-o.ru/zaze/test/test.php` - это покажет информацию о PHP и сервере
2. Проверьте права доступа к файлам (должны быть 644 для файлов, 755 для папок)
3. Убедитесь, что установлены расширения PDO и PDO_MySQL

#### Диагностика ошибок 500

Используйте специальные файлы для диагностики:

**test/test.php** - базовый тест PHP и сервера
```
https://new.a-v-o.ru/zaze/test/test.php
```
Показывает:
- Версию PHP
- Загруженные расширения
- Информацию о сервере

**test/db_test.php** - проверка подключения к базе данных
```
https://new.a-v-o.ru/zaze/test/db_test.php
```
Показывает:
- Статус подключения к БД
- Список таблиц
- Количество пользователей

**test/error_test.php** - подробная диагностика PHP
```
https://new.a-v-o.ru/zaze/test/error_test.php
```
Показывает:
- Все PHP ошибки
- Статус загрузки файлов
- Результаты функций

**test/minimal_test.php** - минимальный тест компонентов
```
https://new.a-v-o.ru/zaze/test/minimal_test.php
```
Показывает:
- PHP работает
- Сессии работают
- config.php загружается
- БД подключается

#### Решение проблем с .htaccess

Если `.htaccess` вызывает ошибки сервера, используйте альтернативные версии из папки `test/`:

**Вариант 1: Рабочий .htaccess (рекомендуется)**
- Скопируйте `test/.htaccess-working` в корень и переименуйте в `.htaccess`
- Без HTTPS перенаправления, только базовая защита

**Вариант 2: Минимальный .htaccess**
- Скопируйте `test/.htaccess-minimal` в корень и переименуйте в `.htaccess`
- Содержит только базовую защиту файлов

**Вариант 3: Безопасный .htaccess**
- Скопируйте `test/.htaccess-safe` в корень и переименуйте в `.htaccess`
- Без потенциально проблемных директив

**Вариант 4: Пошаговое тестирование**
- Скопируйте `test/.htaccess-debug` в корень и переименуйте в `.htaccess`
- Добавляйте правила по одному для выявления проблемного

**Распространенные проблемы:**
- `php_flag engine on` - запрещено на shared hosting
- `ServerSignature Off` - может быть запрещено
- `ServerTokens Prod` - может быть запрещено
- Конфликт с глобальными настройками Apache

### 5. Первый запуск

1. Откройте в браузере `https://new.a-v-o.ru/zaze/login.php`
2. Войдите с учетными данными:
   - Логин: `osokin`
   - Пароль: `40362151`
3. Перейдите в раздел "Управление спектаклями" для настройки базы

**Примечание:** Система использует безопасную аутентификацию через базу данных. Поля логина и пароля пустые для безопасности.

## Использование

### Создание афиши

1. Вставьте текст черновика в поле на главной странице
2. Нажмите "Преобразовать"
3. Просмотрите результат
4. При необходимости сохраните в историю

### Формат черновика

```
месяц год
дата время сокращение_спектакля код_мероприятия
дата время сокращение_спектакля код_мероприятия
	время сокращение_спектакля код_мероприятия  # продолжение предыдущей даты
...
```

**Поддерживаемые форматы времени:**
- `HH` - часы (15 → 15:00)
- `HHMM` - часы и минуты (1530 → 15:30)

**Продолжение дат:**
- Строки с табуляцией в начале наследуют дату от предыдущей строки
- Позволяет указывать несколько спектаклей в один день

Пример:
```
сентябрь 2025
18 19 Тоска 1603
19 19 Летучка 1602
20 12 Любимая 1613
	15 СП 1604        # 20 сентября, 15:00
	19 СП 1605        # 20 сентября, 19:00
21 12 Теремок 1611
	1530 Теремок 1610 # 21 сентября, 15:30
```

### Управление спектаклями

В разделе "Управление спектаклями" можно:
- Добавлять/редактировать спектакли
- Настраивать соответствия сокращений и полных названий
- Создавать шаблоны страниц с ролями

### Шаблоны страниц

Для каждого спектакля можно создать шаблон страницы с ролями. Используйте плейсхолдер `{CODE}` для автоматической подстановки кода мероприятия.

Пример шаблона:
```
==В ролях:==
''СОСТАВ УТОЧНЯЕТСЯ''

'''[https://www.zazerkal.spb.ru/tickets/{CODE}.htm|КУПИТЬ БИЛЕТ]'''
```

## Структура файлов

### Основные файлы (обязательные для работы системы)

- `config.php` - настройки подключения к БД
- `db.php` - функции работы с базой данных
- `parser.php` - логика преобразования текста
- `index.php` - главная страница
- `admin.php` - управление спектаклями
- `history.php` - история афиш
- `login.php` - страница входа
- `schema.sql` - структура базы данных
- `.htaccess` - основные правила безопасности
- `README.md` - документация

### Папка test/ (диагностические и тестовые файлы)

#### Диагностические файлы
- `test/test.php` - базовый тест PHP и сервера
- `test/db_test.php` - тест подключения к базе данных
- `test/error_test.php` - подробная диагностика ошибок PHP
- `test/session_test.php` - тест работы сессий
- `test/minimal_test.php` - минимальный тест PHP функций

#### Файлы для отладки входа
- `test/login_test.php` - полный тест процесса входа
- `test/login_debug.php` - отладка входа без редиректа
- `test/login_fixed.php` - версия с JavaScript редиректом
- `test/login_simple.php` - простейшая версия для тестирования
- `test/login_working.php` - рабочая версия входа
- `test/password_check.php` - проверка паролей

#### Служебные файлы
- `test/generate_password.php` - генератор хэшей паролей

#### Альтернативные .htaccess файлы
- `test/.htaccess-working` - рабочая версия без HTTPS перенаправления
- `test/.htaccess-safe` - безопасная версия без потенциально проблемных директив
- `test/.htaccess-minimal` - минимальная версия только с базовой защитой
- `test/.htaccess-debug` - отладочная версия для пошагового тестирования
- `test/.htaccess-base` - для корневой папки WordPress
- `test/.htaccess-original` - оригинальная версия .htaccess

## Безопасность

### Файл .htaccess

Файл `.htaccess` содержит комплексные правила безопасности для Apache:

- **Защита конфиденциальных файлов**: Блокирует прямой доступ к `config.php`, `db.php`, `parser.php`, `schema.sql`
- **Запрет просмотра директорий**: Предотвращает листинг содержимого папок
- **Безопасные заголовки**: Устанавливает заголовки защиты от XSS, кликджекинга и других атак
- **Защита от SQL-инъекций**: Блокирует подозрительные запросы через URL
- **Сжатие контента**: Оптимизирует передачу данных
- **Кэширование**: Ускоряет загрузку статических ресурсов

### Дополнительные меры безопасности

- **HTTPS включен**: Все соединения автоматически перенаправляются на HTTPS
- **Защита от хотлинкинга**: Настроена для домена new.a-v-o.ru
- Используйте сложные пароли для пользователей
- Регулярно обновляйте пароль администратора
- Ограничьте доступ к директории с файлами
- В продакшене отключите отображение ошибок PHP
- Регулярно обновляйте пароль в базе данных (используйте `password_hash()` для генерации)

## Поддержка

При возникновении проблем проверьте:
1. Настройки подключения к БД в `config.php`
2. Права доступа к файлам
3. Версию PHP (рекомендуется 7.4+)
4. Наличие расширения PDO для MySQL

## Разработка

Для внесения изменений:
1. Модифицируйте соответствующие PHP-файлы
2. Обновите структуру БД при необходимости
3. Протестируйте изменения
4. Обновите документацию
